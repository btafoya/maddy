### [\#734] Relative aliases dont work
**URL**: https://github.com/foxcpp/maddy/issues/734
**State**: CLOSED
**Labels**: bug, 

**Body:**
# Describe the bug

I wanted to create an alternative name for my account using aliases file, but relative names like `cat: dog` (as specified in [docs](https://maddy.email/reference/modifiers/envelope/)) didn't work for me. Maddy didn't do any modifications to the address and returned smtp error "User does not exist". I only managed to make it work with full emails in aliases file: `cat@example.com: dog@example.com`.

Is it error in documentations? For now it says:

```
# Replace 'cat' with any domain to 'dog'.
# E.g. cat@example.net -> dog@example.net
cat: dog
```

but this rule seems to do nothing for me.

# Steps to reproduce


# Configuration file

<details>
  <summary>Spoiler warning</summary>
  
```
## Maddy Mail Server - default configuration file (2022-06-18)
# Suitable for small-scale deployments. Uses its own format for local users DB,
# should be managed via maddy subcommands.
#
# See tutorials at https://maddy.email for guidance on typical
# configuration changes.

# ----------------------------------------------------------------------------
# Base variables

$(hostname) = mx.example.com
$(primary_domain) = exmaple.com
$(local_domains) = $(primary_domain)

debug on

tls file /etc/maddy/certs/fullchain.pem /etc/maddy/certs/privkey.pem

# ----------------------------------------------------------------------------
# Local storage & authentication

# pass_table provides local hashed passwords storage for authentication of
# users. It can be configured to use any "table" module, in default
# configuration a table in SQLite DB is used.
# Table can be replaced to use e.g. a file for passwords. Or pass_table module
# can be replaced altogether to use some external source of credentials (e.g.
# PAM, /etc/shadow file).
#
# If table module supports it (sql_table does) - credentials can be managed
# using 'maddy creds' command.

auth.pass_table local_authdb {
    table sql_table {
        driver sqlite3
        dsn credentials.db
        table_name passwords
    }
}

# imapsql module stores all indexes and metadata necessary for IMAP using a
# relational database. It is used by IMAP endpoint for mailbox access and
# also by SMTP & Submission endpoints for delivery of local messages.
#
# IMAP accounts, mailboxes and all message metadata can be inspected using
# imap-* subcommands of maddy.

storage.imapsql local_mailboxes {
    driver sqlite3
    dsn imapsql.db
}

# ----------------------------------------------------------------------------
# SMTP endpoints + message routing

hostname $(hostname)

table.chain local_rewrites {
    optional_step regexp "(.+)\+(.+)@(.+)" "$1@$3"
    optional_step static {
        entry postmaster postmaster@$(primary_domain)
    }
    optional_step file /etc/maddy/aliases
}

msgpipeline local_routing {
    destination postmaster $(local_domains) {
        modify {
            replace_rcpt &local_rewrites
        }
        deliver_to &local_mailboxes
    }

    default_destination {
        reject 550 5.1.1 "User doesn't exist"
    }
}

smtp tcp://0.0.0.0:25 {
    limits {
        # Up to 20 msgs/sec across max. 10 SMTP connections.
        all rate 20 1s
        all concurrency 10
    }

    dmarc yes
    check {
        require_mx_record
        dkim
        spf
    }

    source $(local_domains) {
        reject 501 5.1.8 "Use Submission for outgoing SMTP"
    }
    default_source {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.1.1 "User doesn't exist"
        }
    }
}

submission tls://0.0.0.0:465 {
    limits {
        # Up to 50 msgs/sec across any amount of SMTP connections.
        all rate 50 1s
    }

    auth &local_authdb

    source $(local_domains) {
        check {
            authorize_sender {
                prepare_email &local_rewrites
                user_to_email identity
            }
        }

        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            modify {
                dkim $(primary_domain) $(local_domains) default
            }
            deliver_to &remote_queue
        }
    }
    default_source {
        reject 501 5.1.8 "Non-local sender domain"
    }
}

target.remote outbound_delivery {
    limits {
        # Up to 20 msgs/sec across max. 10 SMTP connections
        # for each recipient domain.
        destination rate 20 1s
        destination concurrency 10
    }
    mx_auth {
        dane
        mtasts {
            cache fs
            fs_dir mtasts_cache/
        }
        local_policy {
            min_tls_level encrypted
            min_mx_level none
        }
    }
}

target.queue remote_queue {
    target &outbound_delivery

    autogenerated_msg_domain $(primary_domain)
    bounce {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
        }
    }
}

# ----------------------------------------------------------------------------
# IMAP endpoints

imap tls://0.0.0.0:993 {
    auth &local_authdb
    storage &local_mailboxes
}
```
  
</details>

# Environment information

* maddy version: 0.7.1 linux/amd64 go1.23.3

---

## Resolution

**Root cause:**
The `table.file` module's `Lookup` method was performing an exact string match only, failing to correctly implement the documented behavior for relative aliases. The documentation for `table.file` states that "Entries without '@' in 'from' field will match against localpart of address," which was not the actual behavior. This led to aliases like `user: newuser` not being resolved for email addresses like `user@domain.com`.

**Fix summary:**
The `table.file` module (`internal/table/file.go`) has been updated to correctly handle relative aliases. The `Lookup` method now attempts an exact match first. If no exact match is found and the input value is a full email address, it extracts the local-part and attempts a lookup using only the local-part. If a match is found for the local-part and the aliased value does not contain an `@` sign, the original domain part is appended to the aliased value.

**Files changed:**
*   `internal/table/file.go`:
    *   Added `import "github.com/foxcpp/maddy/framework/address"` to enable email address parsing.
    *   Modified the `Lookup` method to implement the described logic for handling relative aliases.
*   `internal/table/file_test.go`:
    *   Added `import "context"` to resolve undefined `context` error.
    *   Added a new test case `TestFileLookupWithRelativeAliases` to verify the correct behavior of relative and absolute aliases, including local-part matching and domain appending.

**How to reproduce (before/after):**
Before:
1.  Create an alias file (e.g., `/etc/maddy/aliases`) with an entry `user: newuser`.
2.  Configure Maddy to use this alias file (e.g., via `table.chain` and `replace_rcpt`).
3.  Send an email to `user@example.com`. Maddy would return "User does not exist" or similar, without applying the alias.

After:
1.  Follow the "Before" steps.
2.  Send an email to `user@example.com`. Maddy will now correctly resolve `user@example.com` to `newuser@example.com` (if `newuser` is a local-part alias) or `newuser` (if `newuser` is a full address alias).

**How to verify:**
1.  Run `go test ./...` in the project root. All tests related to `table` (including `file_test.go`) should pass.
2.  Run `./build.sh` to ensure the project builds successfully.

**Test results:**
All `table` tests, including the new `TestFileLookupWithRelativeAliases`, now pass. The existing `TestGenerateSignVerify` failure in `dkim_test.go` (unrelated to this fix) persists, and `maddy-pam-helper` continues to fail due to environmental issues, as expected.

**Notes / follow-ups:**
The `LookupMulti` method in `internal/table/file.go` has not been modified to handle relative aliases. If such behavior is required for `LookupMulti`, it would need a similar modification. However, the current issue focuses on `Lookup` behavior.