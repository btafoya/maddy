# Maddy Configuration Guide

## Configuration File Location

Default: `/etc/maddy/maddy.conf`

Override with: `maddy run --config /path/to/maddy.conf`

## Configuration Syntax

### Basic Structure

```
# Comment
directive value

module_type instance_name arg1 arg2 {
    directive value
    nested_block {
        directive value
    }
}
```

### Block Types

**Named blocks** (modules):
```
smtp mx_endpoint tcp://0.0.0.0:25 {
    # configuration
}
```

**Inline blocks** (anonymous modules):
```
deliver_to queue {
    target &remote_delivery
}
```

**Module references**:
```
auth &my_auth_provider
```

### Value Types

| Type | Example |
|------|---------|
| String | `hostname mx.example.com` |
| Integer | `max_connections 100` |
| Boolean | `debug on` / `debug off` |
| Duration | `timeout 30s` |
| Size | `appendlimit 32M` |
| List | `protocols imap smtp` |
| Address | `tcp://0.0.0.0:25` |

### Address Formats

```
tcp://0.0.0.0:25          # All interfaces, port 25
tcp://127.0.0.1:587       # Localhost only
tls://0.0.0.0:465         # Implicit TLS
unix:///var/run/sock      # Unix socket
```

## Global Directives

```
# Required: Server hostname
hostname mx.example.com

# State directory (persistent data)
state_dir /var/lib/maddy

# Runtime directory (temporary files)
runtime_dir /run/maddy

# Message domain for generated messages
autogenerated_msg_domain example.com

# Per-domain storage mode
storage_perdomain off

# Per-domain authentication mode
auth_perdomain off

# Authentication domains (if auth_perdomain on)
auth_domains example.com example.org

# Default TLS configuration
tls file /etc/maddy/certs/cert.pem /etc/maddy/certs/key.pem

# Logging
log syslog      # or: stderr, off
debug off

# Authentication username normalization
auth_map_normalize auto  # precis, casefold, auto

# Authentication username mapping
auth_map identity  # or: email_localpart, table reference
```

## TLS Configuration

### File-based Certificates

```
tls file /path/to/cert.pem /path/to/key.pem
```

### Multiple Certificates

```
tls {
    loader file {
        certificates /etc/maddy/certs
    }
}
```

### ACME (Let's Encrypt)

```
tls {
    loader acme {
        # Production mode (default off for testing)
        staging off

        # Contact email
        email admin@example.com

        # Agree to terms of service
        agreed  # Required for production

        # Challenge type
        challenge dns-01 {
            provider cloudflare {
                api_token your_token_here
            }
        }
    }
}
```

### DNS-01 Challenge Providers

| Provider | Configuration |
|----------|---------------|
| cloudflare | `api_token TOKEN` |
| route53 | `access_key_id KEY` `secret_access_key SECRET` |
| digitalocean | `api_token TOKEN` |
| gandi | `api_token TOKEN` |
| hetzner | `api_token TOKEN` |
| vultr | `api_token TOKEN` |
| namecheap | `api_user USER` `api_key KEY` |
| rfc2136 | `server HOST` `key_name NAME` `key_secret SECRET` |

## SMTP Endpoint Configuration

### MX Server (Receiving)

```
smtp tcp://0.0.0.0:25 {
    hostname mx.example.com
    tls &tls_config

    # Limits
    limits {
        all rate 20 1s
        all concurrency 10
    }

    # Message processing
    source example.com {
        check {
            spf
            dkim
            dmarc
        }
        deliver_to &local_mailboxes
    }

    # Default: reject unknown destinations
    default_source {
        reject 550 5.1.1 "User not found"
    }
}
```

### Submission Server (Sending)

```
smtp tls://0.0.0.0:465 tcp://0.0.0.0:587 {
    hostname smtp.example.com
    tls &tls_config

    # Require authentication
    auth &local_auth

    # Add DKIM signature
    modify {
        dkim {
            domain example.com
            selector default
            key_path /var/lib/maddy/dkim_keys/example.com.key
        }
    }

    # Queue for delivery
    deliver_to &outbound_queue
}
```

## IMAP Endpoint Configuration

```
imap tls://0.0.0.0:993 tcp://0.0.0.0:143 {
    tls &tls_config
    auth &local_auth
    storage &local_mailboxes

    # IMAP filters
    imap_filter {
        command /usr/local/bin/sieve {account}
    }
}
```

## Storage Configuration

### SQLite (Default)

```
storage.imapsql local_mailboxes {
    driver sqlite3
    dsn /var/lib/maddy/storage.db

    # Size limits
    appendlimit 32M

    # Compression
    compression zstd
}
```

### PostgreSQL

```
storage.imapsql local_mailboxes {
    driver postgres
    dsn "host=localhost user=maddy password=secret dbname=maddy sslmode=disable"

    appendlimit 32M
}
```

### MySQL

```
storage.imapsql local_mailboxes {
    driver mysql
    dsn "maddy:secret@tcp(localhost:3306)/maddy?charset=utf8mb4"

    appendlimit 32M
}
```

## Authentication Configuration

### Password Table

```
auth.pass_table local_auth {
    table sql_table {
        driver sqlite3
        dsn /var/lib/maddy/credentials.db
        lookup "SELECT password FROM passwords WHERE email = $1"
    }
}
```

### PAM

```
auth.pam local_auth {
    service maddy
}
```

### LDAP

```
auth.ldap ldap_auth {
    urls ldap://ldap.example.com ldaps://ldap2.example.com

    # Bind credentials
    bind_dn cn=maddy,ou=services,dc=example,dc=com
    bind_password secret

    # User search
    base_dn ou=users,dc=example,dc=com
    filter (&(objectClass=inetOrgPerson)(mail={username}))

    # Optional: TLS settings
    starttls on
    tls_client {
        root_ca /etc/ssl/certs/ca-certificates.crt
    }
}
```

## Message Queue Configuration

```
target.queue outbound_queue {
    target &remote_delivery

    # Retry schedule
    max_tries 8
    retry_time 5m
    retry_time_scale 2

    # Bounce handling
    bounce {
        destination &local_mailboxes
    }
}

target.remote remote_delivery {
    hostname mx.example.com

    # Per-destination limits
    limits {
        destination rate 20 1s
        destination concurrency 10
    }

    # MTA-STS
    mtasts required

    # DANE
    dane required
}
```

## Check Configuration

### SPF

```
check.spf {
    fail_action reject         # reject, quarantine, ignore
    softfail_action quarantine
    permerr_action reject
    temperr_action reject
}
```

### DKIM

```
check.dkim {
    require_signature false
    allow_body_subset true
    broken_sig_action ignore
}
```

### DNSBL

```
check.dnsbl {
    reject_threshold 1

    dnsbl zen.spamhaus.org
    dnsbl bl.spamcop.net

    # Whitelist
    whitelist_ip 127.0.0.0/8
    whitelist_ip ::1/128
}
```

### Rspamd

```
check.rspamd {
    api_url http://127.0.0.1:11333

    add_header on
    rewrite_subject on
    reject_threshold 15
}
```

## Complete Example Configuration

```
# Global settings
hostname mx.example.com
state_dir /var/lib/maddy
runtime_dir /run/maddy

# TLS with Let's Encrypt
tls {
    loader acme {
        email admin@example.com
        agreed
        challenge dns-01 {
            provider cloudflare {
                api_token {env:CLOUDFLARE_API_TOKEN}
            }
        }
    }
}

# Local storage
storage.imapsql local_mailboxes {
    driver sqlite3
    dsn storage.db
}

# Authentication
auth.pass_table local_auth {
    table sql_table {
        driver sqlite3
        dsn credentials.db
        lookup "SELECT password FROM passwords WHERE email = $1"
    }
}

# IMAP server
imap tls://0.0.0.0:993 {
    tls &tls
    auth &local_auth
    storage &local_mailboxes
}

# SMTP submission
smtp tls://0.0.0.0:465 tcp://0.0.0.0:587 {
    hostname smtp.example.com
    tls &tls

    auth &local_auth

    check {
        authorize_sender {
            prepare_email identity
        }
    }

    modify {
        dkim {
            domain example.com
            selector default
            key_path dkim_keys/example.com.key
        }
    }

    deliver_to &outbound_queue
}

# SMTP MX
smtp tcp://0.0.0.0:25 {
    hostname mx.example.com
    tls &tls

    source example.com {
        check {
            dnsbl {
                dnsbl zen.spamhaus.org
            }
            spf
            dkim
        }

        deliver_to &local_mailboxes
    }

    default_source {
        reject 550 5.1.1 "User not found"
    }
}

# Outbound queue
target.queue outbound_queue {
    target &remote_delivery

    bounce {
        destination &local_mailboxes
    }
}

target.remote remote_delivery {
    hostname mx.example.com

    limits {
        destination rate 20 1s
    }
}

# Metrics
openmetrics tcp://127.0.0.1:9749 {}
```

## Environment Variables

Use `{env:VAR_NAME}` to reference environment variables:

```
api_token {env:CLOUDFLARE_API_TOKEN}
```

Common environment variables:
- `MADDY_CONFIG` - Config file path
- `MADDY_STATE_DIR` - State directory
- `MADDY_RUNTIME_DIR` - Runtime directory

## Configuration Validation

```bash
# Check configuration syntax
maddy run --config maddy.conf -v
```

## Debugging

```bash
# Enable debug logging
maddy --debug run --config maddy.conf

# Or in configuration
debug on
```
